# Maintainer: ArchStrike <team@archstrike.org>

buildarch=1

pkgname=exploitdb-git
pkgver=20180117.r1458
pkgrel=1
groups=('archstrike' 'archstrike-exploit')
pkgdesc="The official Exploit Database repository"
arch=('any')
url='https://github.com/offensive-security/exploit-database'
license=('GPL')
depends=('bash')
makedepends=('git')
options=('!strip')
replaces=('exploit-db')
conflicts=('exploit-db')
provides=('exploit-database' 'exploit-db' 'exploitdb')
source=("${pkgname}::git+https://github.com/offensive-security/exploit-database.git" 'gitpath.patch')
sha512sums=('SKIP'
            'f4597997d1d41f1287e17e22f0f43b02dae3a29ac8e1010ff9bf35dcbbb2c0d02660219ba4a60d8be1d7e74efcd20b09bea71327a129fb14d78745de619fb7ad')

pkgver() {
  cd "${pkgname}"
  printf "%s.r%s" "$(git show -s --format=%ci master | sed 's/\ .*//g;s/-//g')" "$(git rev-list --count HEAD)"
}

prepare() {
  cd "${pkgname}"
  patch -Np1 -i ${srcdir}/gitpath.patch
}

package() {
  cd "${pkgname}"
  install -dm755 "${pkgdir}/usr/bin"
  install -dm755 "${pkgdir}/usr/share/${pkgname}/platforms"
  cp -a --no-preserve=ownership * "${pkgdir}/usr/share/${pkgname}"

cat > "${pkgdir}/usr/bin/searchsploit" <<EOF
#!/usr/bin/env bash
cd /usr/share/${pkgname}
./searchsploit "\$@"
EOF
chmod 755 "${pkgdir}/usr/bin/searchsploit"
}
